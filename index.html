<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rahul's CA - Personal Finance Tracker (Supabase)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Smooth scrolling */
        html { scroll-behavior: smooth; }
        /* Custom scrollbar for history list */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #334155; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen pb-20 selection:bg-blue-500 selection:text-white">

    <nav class="bg-slate-900 border-b border-slate-800 sticky top-0 z-10 shadow-md">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/20">
                    <i data-lucide="wallet" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">Rahul's CA (Supabase)</h1>
            </div>
            <div id="user-status" class="text-xs text-slate-400 font-medium border border-slate-700 px-2 py-1 rounded-full flex items-center gap-1">
                <span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span> Connecting...
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto px-4 py-6 space-y-6">

        <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 shadow-xl shadow-blue-900/30 text-white relative overflow-hidden transition-all hover:scale-[1.01]">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i data-lucide="wallet" class="w-24 h-24"></i>
            </div>
            <p class="text-blue-100 text-sm font-medium mb-1">Total Balance</p>
            <h2 class="text-4xl font-bold mb-6" id="total-balance">₹ 0</h2>
            
            <div class="flex gap-4">
                <div class="flex items-center gap-2 bg-white/10 px-3 py-2 rounded-lg backdrop-blur-sm flex-1 border border-white/5">
                    <div class="bg-green-400/20 p-1.5 rounded-full">
                        <i data-lucide="arrow-up-circle" class="text-green-300 w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="text-xs text-blue-100">Income</p>
                        <p class="font-semibold text-sm" id="total-income">₹0</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 bg-white/10 px-3 py-2 rounded-lg backdrop-blur-sm flex-1 border border-white/5">
                    <div class="bg-red-400/20 p-1.5 rounded-full">
                        <i data-lucide="arrow-down-circle" class="text-red-300 w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="text-xs text-blue-100">Expense</p>
                        <p class="font-semibold text-sm" id="total-expense">₹0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-slate-900 rounded-2xl p-5 border border-slate-800 shadow-lg">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="plus" class="text-blue-500 w-5 h-5"></i> Add New Entry
            </h3>
            
            <form id="transaction-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-2 bg-slate-950 p-1 rounded-xl border border-slate-800">
                    <button type="button" id="btn-income" class="py-2 text-sm font-medium rounded-lg transition-all text-slate-400 hover:text-slate-200">
                        Money In (+)
                    </button>
                    <button type="button" id="btn-expense" class="py-2 text-sm font-medium rounded-lg transition-all bg-red-600 text-white shadow-lg shadow-red-900/20">
                        Money Out (-)
                    </button>
                </div>
                <input type="hidden" id="type" value="expense">

                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 ml-1">Title / Reason</label>
                        <input type="text" id="title" required
                            placeholder="e.g. Grocery, Rent, Salary"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 transition-colors placeholder:text-slate-600 text-white">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1 ml-1">Amount (₹)</label>
                            <input type="number" id="amount" required step="0.01" min="0"
                                placeholder="0.00"
                                class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 transition-colors placeholder:text-slate-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1 ml-1">Date</label>
                            <div class="relative">
                                <input type="date" id="date" required
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 transition-colors text-slate-200 [color-scheme:dark]">
                                <i data-lucide="calendar" class="absolute right-3 top-3.5 text-slate-500 w-4 h-4 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" id="submit-btn"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl transition-all shadow-lg shadow-blue-900/20 active:scale-[0.98] flex items-center justify-center gap-2">
                    <span>Add Record</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </form>
        </div>

        <div>
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 px-1">
                <i data-lucide="history" class="text-blue-500 w-5 h-5"></i> Transaction History
            </h3>
            
            <div id="transactions-list" class="space-y-3 pb-4">
                <div class="text-center py-10 text-slate-500 animate-pulse">
                    Loading data...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. Supabase SDK Import
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // ==========================================
        // CONFIGURATION (FINAL KEYS)
        // ==========================================
        const SUPABASE_URL = 'https://apnghuplnfohtiwyeic.supabase.co' 
        const SUPABASE_ANON_KEY = 'sb_publishable_e39f8tjy9dada14i9mwf_g_rvzdw8r'
        
        // 2. Initialize Supabase Client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let current_user_id = null;

        // ==========================================
        // APP LOGIC
        // ==========================================

        const form = document.getElementById('transaction-form');
        const listContainer = document.getElementById('transactions-list');
        const totalBalanceEl = document.getElementById('total-balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const userStatusEl = document.getElementById('user-status');
        
        // Type Switcher Logic 
        const btnIncome = document.getElementById('btn-income');
        const btnExpense = document.getElementById('btn-expense');
        const typeInput = document.getElementById('type');

        document.getElementById('date').valueAsDate = new Date();

        btnIncome.addEventListener('click', () => {
            typeInput.value = 'income';
            btnIncome.className = "py-2 text-sm font-medium rounded-lg transition-all bg-green-600 text-white shadow-lg shadow-green-900/20";
            btnExpense.className = "py-2 text-sm font-medium rounded-lg transition-all text-slate-400 hover:text-slate-200";
            document.getElementById('title').placeholder = "e.g. Salary, Freelance Payment";
        });

        btnExpense.addEventListener('click', () => {
            typeInput.value = 'expense';
            btnExpense.className = "py-2 text-sm font-medium rounded-lg transition-all bg-red-600 text-white shadow-lg shadow-red-900/20";
            btnIncome.className = "py-2 text-sm font-medium rounded-lg transition-all text-slate-400 hover:text-slate-200";
            document.getElementById('title').placeholder = "e.g. Grocery, Rent, Bills";
        });


        // 3. User Authentication (Anonymous Login)
        async function handleUserAuth() {
            try {
                // Supabase Anonymous Sign In
                let { data: { user } } = await supabase.auth.signInAnonymously();
                
                if (user) {
                    current_user_id = user.id;
                    userStatusEl.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full"></span> Online (${user.id.substring(0, 4)}...)`;
                    setupRealtimeListener();
                } else {
                    userStatusEl.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full"></span> Auth Error`;
                }

            } catch (error) {
                console.error("Supabase Auth Error:", error);
                userStatusEl.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full"></span> Connection Failed`;
                listContainer.innerHTML = `<div class="text-center text-red-400 p-4">Error: Check your URL/Key and RLS rules.</div>`;
            }
        }

        // 4. Add Transaction
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!current_user_id) {
                alert("Please wait for connection/login...");
                return;
            }

            const title = document.getElementById('title').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;

            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = "Saving...";
            submitBtn.disabled = true;

            try {
                // Insert data into the 'transactions' table
                const { error } = await supabase
                    .from('transactions')
                    .insert([
                        { 
                            title, 
                            amount, 
                            type, 
                            date, 
                            user_id: current_user_id // IMPORTANT: User ID save karna zaruri hai RLS ke liye
                        },
                    ]);

                if (error) throw error;

                // Reset Form
                document.getElementById('title').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('title').focus();
            } catch (error) {
                console.error("Error adding document: ", error.message);
                alert("Error saving transaction: " + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // 5. Real-time Listener and Data Fetching
        function setupRealtimeListener() {
             // Initial fetch (for the first load)
             fetchTransactions();

             // Realtime listener for future changes
             supabase
                .channel('schema-db-changes')
                .on(
                    'postgres_changes',
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'transactions',
                        filter: `user_id=eq.${current_user_id}` // Sirf user ka apna data sunna
                    },
                    (payload) => {
                        console.log('Change received!', payload);
                        // Jab koi change ho, toh poora data dobara fetch karein
                        fetchTransactions();
                    }
                )
                .subscribe();
        }

        async function fetchTransactions() {
            if (!current_user_id) return;
            
            // Filter: user_id ke barabar ho AND Order: date ke hisaab se descending
            const { data: transactions, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('user_id', current_user_id) 
                .order('date', { ascending: false }); 

            if (error) {
                console.error("Fetch Error:", error);
                listContainer.innerHTML = `<div class="text-center text-red-400 p-4">Error fetching data: ${error.message}</div>`;
                return;
            }

            let income = 0;
            let expense = 0;

            transactions.forEach((t) => {
                if (t.type === 'income') {
                    income += t.amount;
                } else {
                    expense += t.amount;
                }
            });

            updateUI(transactions, income, expense);
        }

        // 6. Delete Transaction
        window.deleteTransaction = async (id) => {
            if (!current_user_id) return;
            if (confirm('Are you sure you want to delete this entry?')) {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', id); // ID ke hisaab se delete karein

                    if (error) throw error;
                } catch (error) {
                    console.error("Error deleting:", error.message);
                    alert("Could not delete: " + error.message);
                }
                // Realtime listener automatically update karega
            }
        };

        // Update UI Function
        function updateUI(transactions, income, expense) {
            // Update Totals
            totalIncomeEl.textContent = `₹${income.toLocaleString('en-IN')}`;
            totalExpenseEl.textContent = `₹${expense.toLocaleString('en-IN')}`;
            
            const balance = income - expense;
            totalBalanceEl.textContent = `₹ ${balance.toLocaleString('en-IN')}`;

            // Render List
            if (transactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-10 text-slate-500 bg-slate-900 rounded-2xl border border-slate-800 border-dashed">
                        <p>No transactions yet.</p>
                        <p class="text-xs mt-1">Add your first income or expense.</p>
                    </div>`;
            } else {
                listContainer.innerHTML = transactions.map(t => `
                    <div class="group bg-slate-900 hover:bg-slate-800 border border-slate-800 rounded-xl p-4 flex justify-between items-center transition-all animate-in fade-in slide-in-from-bottom-2 duration-300">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full ${t.type === 'income' ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'}">
                                <i data-lucide="${t.type === 'income' ? 'plus' : 'minus'}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="font-medium text-slate-200 capitalize">${t.title}</p>
                                <p class="text-xs text-slate-500">${t.date}</p>
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <p class="font-bold text-sm ${t.type === 'income' ? 'text-green-400' : 'text-red-400'}">
                                ${t.type === 'income' ? '+' : '-'} ₹${t.amount.toLocaleString('en-IN')}
                            </p>
                            <button onclick="window.deleteTransaction('${t.id}')"
                                class="text-xs text-slate-600 hover:text-red-400 mt-1 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            }
        }
        
        // Initial setup call
        handleUserAuth();
        lucide.createIcons();
    </script>
</body>
</html>


